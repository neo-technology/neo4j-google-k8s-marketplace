apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ template "neo4j.fullname" . }}-ubc
  labels:
    release: {{ .Values.name | quote }}
    chart: "{{ .Chart.Name }}-{{ .Chart.Version }}"
    app: {{ template "neo4j.name" . }}
    component: ubbagent-config 
data:
  ubbagent-config.yaml: |
    # This configuration writes aggregated metrics to disk under the
    # /var/ubbagent/reports directory. Two metrics are written:
    # * requests - Some number of "requests". This metric should be
    #     reported to the agent's HTTP endpoint by an external source.
    # * instance-seconds - the number of seconds that the agent (and
    #     the associated metered software) has been running. Reports
    #     for this metric are automatically generated by the
    #     "instance-seconds" source at intervals of 10 seconds.
    # The metrics section defines the metric names and types that the agent
    # is configured to record.
    metrics:
    - name: requests
      type: int
      # The endpoints section of a metric defines which endpoints the metric data
      # is sent to.
      endpoints:
      - name: disk
      # The aggregation section indicates that reports that the agent receives for
      # this metric should be aggregated for a specified period of time prior to
      # being sent to the reporting endpoint.
      aggregation:
        bufferSeconds: 10
    - name: instance-seconds
      type: int
      # The empty passthrough second indicates that no aggregation should occur for
      # this metric. Reports received are immediately sent to the reporting
      # endpoint. Passthrough is used for this metric since its only source is a
      # `heartbeat` which sends at a configured interval of 10 seconds.
      passthrough: {}
      endpoints:
      - name: disk
    # The endpoints section defines where metering data is ultimately sent.
    # Currently supported endpoints include:
    # * disk - some directory on the local filesystem
    # * servicecontrol - Google Service Control:
    #   https://cloud.google.com/service-control/overview
    endpoints:
    - name: disk
      disk:
        reportDir: /var/ubbagent/reports
        expireSeconds: 3600
    # The sources section lists metric data sources run by the agent itself. The
    # currently-supported source is 'heartbeat', which sends a defined value to a
    # metric at a defined interval.
    sources:
    - name: instance-seconds
      heartbeat:
        metric: instance-seconds
        intervalSeconds: 10
        value:
          int64Value: 10
        labels:
          auto: true
